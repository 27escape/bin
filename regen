#!/bin/bash
# create prince PDF version of the markdown file

# ---------------------------------------------------------------------------

function usage() {
  echo "
  usage: $0 option 

  regenerate markdown document into PDF

  OPTIONS:
    -h    this help
    -e    will launch evince to preview it
    -c    create a cleanly built version

"
}

# ---------------------------------------------------------------------------

function check_version() {
  fname=$1

  fdate=`grep -E '^date: ' $fname | awk '{print $2}'| head -1`
  echo $fdate |grep -qE "[0-9]{4}-[0-9]{2}-[0-9]{2}"
  if [ "$?" != "0" ] ; then
    echo "ERROR: keyword date value does not seem to be valid"
  fi

  version=`grep -E '^version: ' $fname | awk '{print $2}'|head -1`

  if [ "$version" != "" ] ; then
    vdate=`grep -E "^$version " $fname | awk '{print $2}' |head -1`
    echo $vdate |grep -qE "[0-9]{4}-[0-9]{2}-[0-9]{2}"
    if [ "$?" != "0" ] ; then
      echo "ERROR: version date part does not seem to be valid"
    fi

    # grep -qE "^$version [0-9]{4}-[0-9]{2}-[0-9]{2}" $fname
    grep -qE "^$version $fdate" $fname
    if [ "$?" != "0" ] ; then
      echo "ERROR: Could not match version number and release date"
    fi
  fi
}

# ---------------------------------------------------------------------------

CLEAN=""
# process command line args

while getopts “hec” OPTION
do
  case $OPTION in
    h) usage
      exit 1
      ;;
    e) LAUNCH="evince "
      ;;
    c) CLEAN="-c"
      ;;
    *) usage
      exit 1
      ;;
  esac
done
# remove the options we used
shift $(($OPTIND -1))

filepath="$1"
# echo "file $filepath"

echo "$filepath" |grep -Eq '\.md$'
if [ "$?" == "0" ] ; then
  # should we write it to a PDF dir
  b=`dirname $filepath`
  f=`basename $filepath .md`
  PDF="$b/PDF"
  DOC="$b/docs"
  if [ -d "$PDF" ] ; then
    OUTPUT="$PDF/"
  else
    if [ -d "$DOC" ] ; then
      OUTPUT="$DOC/"
    fi
  fi
  check_version $filepath

  # if we have a version number append it to the end
  if [ "$version" != "" ] ; then
    f="$f-v$version" 
  fi
  # build into output dir + filename with version number
  OUTPUT="$OUTPUT$f.pdf"

  OUT=`ct2 -p $CLEAN "$filepath" -v -o "$OUTPUT"`
  # only launch if the output file was created
  if [ "$LAUNCH" != "" -a -f "$OUT" ] ; then
    # echo "opening $OUT"
    $LAUNCH "$OUT" &
  else
    echo "Procesed to $OUT"
  fi
else
    echo "This does not appear to be a markdown file (.md)"
    usage
    exit 1
fi
